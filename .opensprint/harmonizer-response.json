{
  "status": "success",
  "prd_updates": [
    {
      "section": "technical_architecture",
      "action": "update",
      "content": "### Architecture Overview\n\nThree primary layers: web frontend, backend API server, and background agent CLI. Frontend uses WebSockets for real-time updates and REST for CRUD. Backend orchestrates agent CLIs, manages project state, and maintains the living PRD. Fully offline-capable with local agents and default local Docker Postgres.\n\n### Technology Stack\n\n- **Backend:** Node.js + TypeScript (subprocess management, WebSocket, agent CLI via `child_process`)\n- **Frontend:** React + TypeScript\n- **Task store:** PostgreSQL (node-postgres) — database URL in `~/.opensprint/global-settings.json`; default local Docker Postgres; supports remote URLs (e.g., Supabase)\n- **Version control:** Git, branch-per-task; worktrees or branches mode (configurable in Agent Config)\n\n### Core Components\n\n| Component           | Responsibility |\n| ------------------- | -------------- |\n| Web Frontend        | UI for all five phases; real-time agent monitoring |\n| Backend API         | Project state, WebSocket relay, PRD versioning, agent orchestration |\n| Agent CLI           | Code generation, testing, debugging (Claude/Cursor/Custom) |\n| Orchestration Layer | Deterministic Node.js; agent lifecycle; git/task ops; commit queue; watchdog |\n| Task store (Postgres) | Task CRUD, dependencies, `ready()`, assignee, hierarchical IDs; feedback, deployments, sessions, orchestrator data |\n| Test Runner         | Jest, Playwright, etc. — auto-detected from `package.json` |\n| Deployment          | Expo.dev or custom pipeline |\n\n### Orchestrator Trust Boundary\n\nOrchestrator owns: worktree/branch management, commits/merges, agent triggering, task store state transitions, task creation, PRD updates (except Dreamer direct write). Agents produce outputs; orchestrator performs all critical operations.\n\n### Data Flow\n\nSketch → PRD. Plan → Plan markdowns (epics). Execute → tasks in task store. Agent CLIs execute tasks. Evaluate → feedback mapped to epics/tasks or linked to existing open tasks. Changes propagate upstream to PRD.\n\n### Orchestrator Lifecycle\n\nOne orchestrator per project, always on. Single Coder/Reviewer at a time (v1); Planning-slot agents concurrent. Event-driven + 5-min watchdog. State in `.opensprint/orchestrator-state.json`; recovery on crash.\n\n### Git Concurrency\n\nSerialized commit queue for main-branch ops. Task data persisted in PostgreSQL; no task data committed to repo.",
      "change_log_entry": "Migrate task store from sql.js to PostgreSQL; add global-settings.json for database URL; support Docker Postgres and remote URLs."
    },
    {
      "section": "data_model",
      "action": "update",
      "content": "### 10.1 Entity Relationship Overview\n\n```\nUser (implicit, single-user)\n  └── Project (1:many)\n        ├── PRD (1:1, JSON file)\n        ├── AgentConfig (1:1, embedded in project settings)\n        ├── Conversation (1:many, per phase/context)\n        │     └── Message (1:many, ordered)\n        ├── Plan (1:many, markdown files)\n        │     └── Task (1:many, tasks with parent-child IDs e.g. os-xxxx.1)\n        │           └── AgentSession (1:many, per attempt)\n        ├── FeedbackItem (1:many)\n        ├── DeploymentRecord (1:many)\n        └── Settings (1:1, project configuration, stored in global database)\n```\n\n### 10.2 Entity Definitions\n\n#### Project\n\n| Field         | Type          | Description                              |\n| ------------- | ------------- | ---------------------------------------- |\n| id            | string (UUID) | Unique project identifier                |\n| name          | string        | Display name                             |\n| repo_path     | string        | Absolute path to the git repository      |\n| created_at    | datetime      | Creation timestamp                       |\n| updated_at    | datetime      | Last modification timestamp              |\n| current_phase | enum          | sketch / plan / execute / eval / deliver |\n\n#### PRD (PRDDocument)\n\nStored as `.opensprint/prd.json`. Top-level fields:\n\n| Field      | Type   | Description                                                                                                                         |\n| ---------- | ------ | ----------------------------------------------------------------------------------------------------------------------------------- |\n| version    | number | Monotonically increasing document version                                                                                           |\n| sections   | object | Keyed by section name (e.g., `executive_summary`); each value has `content` (markdown), `version` (number), `updated_at` (datetime) |\n| change_log | array  | Entries with `section`, `version`, `source` (which phase triggered the change), `timestamp`, `diff`                                 |\n\n#### Conversation\n\nStored as `.opensprint/conversations/<conversation-id>.json`. Created per phase context (one for Sketch chat, one per Plan sidebar). Fields: `id`, `context` (sketch / plan:\\<plan-id\\>), `messages[]`. Each message: `role` (user/assistant), `content` (markdown), `timestamp`, `prd_changes[]` (optional — PRD sections modified by this message).\n\n#### Plan\n\nStored as `.opensprint/plans/<plan-id>.md` in the project repo. The Plan markdown file is associated to its epic as the design document metadata — the epic's `description` field contains the path to the Plan markdown file (e.g., `.opensprint/plans/auth.md`), making the Plan the authoritative specification that agents reference when implementing child tasks. Additional metadata:\n| Field | Type | Description |\n|-------|------|-------------|\n| plan_id | string | Unique identifier (matches filename) |\n| epic_id | string | Corresponding epic (task) ID (e.g., `os-a3f8`). Plan status (planning/building/complete) is derived from epic status and task completion: planning = epic blocked; building = epic open + tasks pending; complete = all done. |\n| shipped_at | datetime | When the user clicked \"Execute!\" (null if still in planning) |\n| complexity | enum | low / medium / high / very_high |\n\n#### Task\n\nRepresented as tasks (child IDs under the Plan's epic, e.g. `os-a3f8.1`). OpenSprint reads/writes these via `TaskStoreService`. Key fields:\n\n| Field        | Description                                                                                                               |\n| ------------ | ------------------------------------------------------------------------------------------------------------------------- |\n| id           | Task ID (e.g., `os-a3f8.1`)                                                                                               |\n| title        | Task title                                                                                                                |\n| description  | Task specification                                                                                                        |\n| status       | open / in_progress / closed / blocked. Epic tasks: `blocked` = plan not approved; `open` = approved; `closed` = complete. |\n| priority     | 0-4 (0 = highest)                                                                                                         |\n| assignee     | Agent instance ID when in progress                                                                                        |\n| labels       | User-defined labels for categorization                                                                                    |\n| dependencies | `blocks` relationships to other tasks                                                                                     |\n\n#### AgentSession\n\nStored in PostgreSQL (agent_sessions table). Fields: `task_id`, `attempt`, `agent_type` (claude/cursor/custom), `agent_model`, `started_at`, `completed_at`, `status` (success/failed/timeout/cancelled/approved/rejected), `output_log` (filepath), `git_branch`, `git_diff` (filepath), `test_results`, `failure_reason`.\n\n#### FeedbackItem\n\nStored in PostgreSQL (feedback table). Fields: `id`, `text` (user's natural language feedback), `category` (bug/feature/ux/scope), `mapped_plan_id`, `created_task_ids` (task IDs created from this feedback), `status` (pending/mapped/resolved), `created_at`.\n\n#### DeploymentRecord\n\nStored in PostgreSQL (deployments table). Fields: `id`, `commit_hash` (git SHA deployed), `target` (staging/production), `mode` (expo/custom), `status` (pending/in_progress/success/failed/rolled_back), `started_at`, `completed_at`, `url` (deployed URL if available), `log_path` (filepath to deployment output log), `rolled_back_by` (deploy ID if this deployment was rolled back).\n\n#### GlobalSettings\n\nStored in `~/.opensprint/global-settings.json`. Fields: `databaseUrl` (optional; default: `postgresql://opensprint:opensprint@localhost:5432/opensprint` for local Docker Postgres). Read before any DB connection. Masked in API responses (host/port only, password hidden).\n\n#### ProjectSettings\n\nStored in `~/.opensprint/settings.json` keyed by project ID. Not in per-project files. Fields: `planning_agent` ({ type, model, cli_command }), `coding_agent` ({ type, model, cli_command }), `deployment` ({ mode, expo_config, custom_command }), `hil_config` (per-category notification mode), `test_framework`, `test_command` (auto-detected from `package.json`, default: `npm test`, overridable).\n\n**UserPreferences** (frontend-only): Theme stored in `localStorage` at `opensprint.theme` (light/dark/system).\n\n### 10.3 Storage Strategy\n\n**Global settings:** `~/.opensprint/global-settings.json` stores `databaseUrl` (PostgreSQL connection string). Read before any DB init. Default: local Docker Postgres.\n\n**Project index:** `~/.opensprint/projects.json` maps project IDs to repo paths (`id`, `name`, `repo_path`, `created_at`).\n\n**Database (PostgreSQL):** Tasks, task dependencies, feedback, agent sessions, orchestrator events, deployments, plans — all stored in PostgreSQL. URL configurable via global-settings. When URL is local (localhost), `npm run dev` ensures Docker Postgres is running before server boot.\n\n**Project settings:** `~/.opensprint/settings.json` keyed by project ID.\n\n**Per-project data:** PRD, plans, conversations live in the project's `.opensprint/` directory (version-controlled). AGENTS.md in repo root; editable via agents instructions API. Backend maintains in-memory index rebuilt from filesystem on startup.",
      "change_log_entry": "Add GlobalSettings entity; migrate task, feedback, session, deployment, orchestrator data to PostgreSQL; document global-settings.json and storage strategy."
    },
    {
      "section": "api_contracts",
      "action": "update",
      "content": "### REST API (`/api/v1`)\n\n**Global Settings:** GET `/global-settings` — Returns global settings including masked `databaseUrl` (host/port only, password hidden). PUT `/global-settings` — Body `{ databaseUrl?: string }`, validates URL format. Server may need restart if URL changes.\n\n**Projects:** GET/POST `/projects`, GET/PUT/DELETE `/projects/:id`\n\n**PRD:** GET/PUT `/projects/:id/prd`, GET `/projects/:id/prd/:section`, GET `/projects/:id/prd/history`\n\n**Plans:** GET/POST `/projects/:id/plans`, GET/PUT `/projects/:id/plans/:planId`, POST `/projects/:id/plans/:planId/execute`, POST `/projects/:id/plans/:planId/re-execute`, GET `/projects/:id/plans/dependencies`\n\n**Tasks:** GET `/projects/:id/tasks`, GET `/projects/:id/tasks/ready`, GET `/projects/:id/tasks/:taskId`, GET `/projects/:id/tasks/:taskId/sessions`, GET `/projects/:id/tasks/:taskId/sessions/:attempt`. Task responses include `sourceFeedbackIds?: string[]` when the task has linked feedback (derived from discovered-from dependencies).\n\n**Execute:** GET `/projects/:id/execute/status`\n\n**Evaluate:** GET/POST `/projects/:id/feedback`, GET `/projects/:id/feedback/:feedbackId`\n\n**Deploy:** POST `/projects/:id/deploy`, GET `/projects/:id/deploy/status`, GET `/projects/:id/deploy/history`, POST `/projects/:id/deploy/:deployId/rollback`, PUT `/projects/:id/deploy/settings`\n\n**Chat:** POST `/projects/:id/chat`, GET `/projects/:id/chat/history`\n\n**Agents:** GET `/projects/:id/agents/instructions` — Returns `{ content: string }` (AGENTS.md). PUT `/projects/:id/agents/instructions` — Body `{ content: string }`, writes to repo root AGENTS.md.\n\n### WebSocket (`ws://localhost:<port>/ws/projects/:id`)\n\n**Server → Client:** `task.updated`, `task.blocked`, `agent.output`, `agent.completed`, `prd.updated`, `execute.status`, `hil.request`, `feedback.mapped`, `deploy.started`, `deploy.completed`, `deploy.output`\n\n**Client → Server:** `agent.subscribe`, `agent.unsubscribe`, `hil.respond`",
      "change_log_entry": "Add GET/PUT /api/v1/global-settings for database URL configuration."
    },
    {
      "section": "feature_list",
      "action": "update",
      "content": "Add under Project Setup & Configuration:\n\n- **Help modal (?):** Available on both homepage and per-project view. Two tabs: \"Ask a Question\" (default) and \"Meet your Team\". Ask a Question is a chat area with an AI agent in ask-only mode — explicitly instructed to answer only, never to change project state, PRD, or tasks. The agent receives project context when in per-project view (PRD, Plans, tasks, current agent status) or summary info about all projects when on homepage. Includes instructions for accessing more information about projects, tasks, and currently running agents. Meet your Team displays configured agents and their roles.\n\n- **AGENTS.md editor in Agent Config:** Project Settings → Agent Config includes a section to view (rendered markdown) and edit the project's AGENTS.md file in the repo root. Changes are saved via API; enables users to customize project-specific agent instructions without leaving the UI.\n\n- **Global Settings UI:** Database section for configuring database URL. Default: local Docker Postgres (`postgresql://opensprint:opensprint@localhost:5432/opensprint`). Supports remote Postgres URLs (e.g., Supabase). Accessible from Settings/Admin area. Help text: \"Leave default for local Docker Postgres, or use a remote URL.\" Migration script `npx tsx scripts/migrate-sqlite-to-postgres.ts` for existing SQLite users.\n\nAdd under Evaluate:\n\n- **Feedback link to existing tasks:** When the Analyst categorizes feedback, it receives a list of open tasks and may link feedback to existing tasks instead of creating new ones, reducing ticket proliferation. Tasks may have multiple linked feedback items; the Execute sidebar displays all of them.",
      "change_log_entry": "Add Global Settings UI with Database section for PostgreSQL URL configuration and migration script."
    }
  ]
}
